extends ../../layout
block content
  .container-fluid
    .row
      .col-md-5
        form(action="/profesional/crearPrescripcion", method="post")
          .form-group
            label(for="paciente") Seleccionar Paciente:
            input.form-control(type="text", id="paciente", name="paciente", list="pacientes")
            datalist(id="pacientes")
                each paciente in pacientes
                    option(value=`${paciente.nombre_paciente} ${paciente.apellido_paciente}` data-id=paciente.id_paciente)= `DNI: ${paciente.documento_paciente}`
            input(type="hidden" id="id_paciente" name="id_paciente")

          .form-group
            label(for="nombrePrestacion") Nombre de Estudio:
            input.form-control(type="text", id="nombrePrestacion", name="nombrePrestacion")

          .form-group
            label(for="lado") Lado:
            input.form-control(type="text", id="lado", name="lado")

          .form-group
            label(for="indicacion") Indicación:
            input.form-control(type="text", id="indicacion", name="indicacion")

          .form-group
            label(for="justificacion") Justificación:
            input.form-control(type="text", id="justificacion", name="justificacion")

          .form-group
            label(for="diagnostico") Diagnóstico:
            input.form-control(type="text", id="diagnostico", name="diagnostico")

          .form-group
            label(for="presentacion") Seleccionar Presentación:
            input.form-control(type="text", id="presentacion", name="presentacion", list="presentacionesData")
            datalist(id="presentacionesData")
              each presentacion in presentaciones
                option(value=`${presentacion.Medicamento.nombre_generico} ${presentacion.concentracion}${presentacion.u_medida} | ${presentacion.Forma_farmaceutica.forma_farmaceutica}` data-id=presentacion.id_presentacion)=`${presentacion.Categoria.categoria}: ${presentacion.Familia.familia}`
            button.btn.btn-secondary(type="button", id="agregarPresentacion") Agregar
            br
            button.btn.btn-primary.mt-3(type="submit") Crear Prescripción

            #presentacionOculta

      .col-md-7 
        h2 Presentaciones Agregadas
        table.table.table-striped
          thead
            tr
              th Medicamento
              th Dosis
              th Duración
              th Acciones
          tbody#presentacionesTable
block scripts
  script(src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js")
  script.
    $(document).ready(function() {
      $('#paciente').on('input', function() {
        const pacienteText = $(this).val();
        const pacienteOption = $('#pacientes option').filter(function() {
          return this.value === pacienteText;
        });
        const pacienteId = pacienteOption.data('id');
        $('#id_paciente').val(pacienteId);
      });

      $('#agregarPresentacion').click(function() {
        const presentacionText = $('#presentacion').val();
        const presentacionOption = $('#presentacionesData option').filter(function() {
          return this.value === presentacionText;
        });
        const presentacionId = presentacionOption.data('id');
        if (presentacionId) {
          const presentacionesTable = $('#presentacionesTable');
          const row = `
            <tr data-id="${presentacionId}">
              <td>${presentacionText}</td>
              <td><input type="text" class="form-control dosis" name="dosisX" placeholder="Dosis"></td>
              <td><input type="text" class="form-control duracion" name="duracionX" placeholder="Duración"></td>
              <td><button type="button" class="btn btn-danger btn-sm eliminarPresentacion">Eliminar</button></td>
            </tr>
          `;
          presentacionesTable.append(row);

          // Crear un campo oculto para almacenar el ID de esta presentación
          const input = $('<input>').attr({
            type: 'text',
            name: 'presentaciones',
            value: presentacionId
          });
          $('#presentacionOculta').append(input);
          $('#presentacion').val('');
        }
      });

      // Eliminar presentación de la tabla
      $(document).on('click', '.eliminarPresentacion', function() {
        $(this).closest('tr').remove();
      });
    });